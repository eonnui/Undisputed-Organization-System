{% extends 'admin_base.html' %} 
{% block title %}Admin Membership and Payments{% endblock %} 
{% block head %} 
    <link rel="stylesheet" href="{{ url_for('static', path='css/admin_dashboard.css') }}"> 
    <link rel="stylesheet" 
          href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200"/> 
    <style> 
        .action-button-container { 
            display: flex; 
            gap: 5px; 
            align-items: center; 
        } 

        .action-button-container select { 
            padding: 8px; 
            border: 1px solid var(--accent-light); 
            border-radius: 4px; 
            font-size: 14px; 
            background-color: var(--highlight); 
            color: var(--text-primary); 
        } 

        .action-button-container button { 
            background-color: var(--button-bg); 
            color: var(--button-text); 
            border: none; 
            padding: 8px 12px; 
            border-radius: 4px; 
            cursor: pointer; 
            font-size: 14px; 
        } 

        .action-button-container button:hover { 
            background-color: var(--hover-effect); 
        } 

        .past-due { 
            color: red; 
        } 

        .unpaid { 
            color: #e6b800; 
        } 

        .paid { 
            color: green; 
        } 

        .not-responsible { 
            color: #808080; 
        } 

        .disabled-button { 
            background-color: #cccccc; 
            color: #666666; 
            cursor: not-allowed; 
        } 

        .disabled-button:hover { 
            background-color: #cccccc; 
        } 

        .action-button-container.disabled { 
            display: none; 
        }       
    </style> 
{% endblock %} 

{% block content %} 
    <div class="tabs"> 
        <button class="tab-button active" onclick="openTab('membership')">Membership</button> 
        <button class="tab-button" onclick="openTab('payments')">Payments</button> 
    </div> 

    <div id="membership" class="tab-content active"> 
        <div class="payments-page-container"> 
            <h2 class="payments-header">Membership</h2> 
            <div class="header-actions"> 
            </div> 
            <div class="payments-table-container"> 
                <table class="payments-table" id="membership-table"> 
                    <thead> 
                    <tr> 
                        <div class="custom-select-wrapper" id="academic-year-filter-wrapper"> 
                            <div class="custom-select-trigger" id="academic-year-filter-trigger"> 
                                <span>Academic Year</span> 
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"> 
                                    <path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg> 
                            </div> 
                            <div class="custom-options" id="academic-year-filter-options"> 
                                <ul role="listbox" id="academic-year-dropdown"> 
                                    <li data-value="">All</li> 
                                    <li data-value="2027-2028">2027-2028</li> 
                                    <li data-value="2026-2027">2026-2027</li> 
                                    <li data-value="2025-2026">2025-2026</li> 
                                    <li data-value="2024-2025">2024-2025</li> 
                                    <li data-value="2023-2024">2023-2024</li> 
                                    <li data-value="2022-2023">2022-2023</li> 
                                </ul> 
                            </div> 
                        </div> 
                        </div> 
                        <div class="custom-select-wrapper" id="semester-filter-wrapper"> 
                            <div class="custom-select-trigger" id="semester-filter-trigger"> 
                                <span>Semester</span> 
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"> 
                                    <path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg> 
                            </div> 
                            <div class="custom-options" id="semester-filter-options"> 
                                <ul role="listbox" id="semester-dropdown"> 
                                    <li data-value="">All</li> 
                                    <li data-value="1st">1st</li> 
                                    <li data-value="2nd">2nd</li> 
                                </ul> 
                            </div> 
                        </div> 
                        </div> 
                        <th>Year Level</th> 
                        <th>Section</th> 
                        <th>Total Paid</th> 
                        <th>Total Amount</th> 
                        <th>Status</th> 
                        <th>List</th> 
                    </tr> 
                    </thead> 
                    <tbody> 
                    </tbody> 
                    <tfoot> <tr>
                            <td colspan="2">Totals:</td>
                            <td id="total-paid-sum">0</td>
                            <td id="total-amount-sum">0</td>
                            <td id="total-status-summary"></td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table> 
            </div> 
        </div> 
    </div> 

    <div id="payments" class="tab-content"> 
        <div class="payments-page-container"> 
            <h2 class="payments-header">Payments</h2> 
            <div class="header-actions"> 
            </div> 

            <div class="payments-table-container"> 
                
                    {% set student_payments = {} %}
                    {% for item_with_status in payment_items %}
                        {% set student_number = item_with_status.student_number %}
                        {% if student_number not in student_payments %}
                            {% set _ = student_payments.update({student_number: []}) %}
                        {% endif %}
                        {% set _ = student_payments[student_number].append(item_with_status) %}
                    {% endfor %}

                    {% for student_number, payments in student_payments.items() %}
                        <table class="payments-table">
                            <thead>
                                <tr>
                                    <th>Student Number</th>
                                    <th>Academic Year</th> 
                                    <th>Semester</th> 
                                    <th>Fee</th> 
                                    <th>Due Date</th> 
                                    <th>Status</th> 
                                    <th>Action</th> 
                                </tr>
                            </thead>
                            <tbody>
                                {% for item_with_status in payments %}
                                    <tr>
                                        <td>{{ item_with_status.student_number }}</td>
                                        <td>{{ item_with_status.item.academic_year }}</td> 
                                        <td>{{ item_with_status.item.semester }}</td> 
                                        <td>{{ item_with_status.item.fee }}</td> 
                                        <td>{{ item_with_status.item.due_date.strftime('%Y-%m-%d') if item_with_status.item.due_date else 'Not Set' }}</td> 
                                        <td class="{% if item_with_status.item.is_not_responsible %}not-responsible{% else %}{{ item_with_status.status.lower() }}{% endif %}"> 
                                            {% if item_with_status.item.is_not_responsible %} 
                                                NR 
                                            {% else %} 
                                                {{ item_with_status.status }} 
                                            {% endif %} 
                                        </td> 
                                        <td> 
                                            {% if item_with_status.status == "Past Due" %} 
                                                <div class="action-button-container"> 
                                                    <form method="post"  action="/admin/payment/{{ item_with_status.item.id }}/update_status"> 
                                                        <select name="status" id="status-select-{{ item_with_status.item.id }}"> 
                                                            <option value="Unpaid" {% if item_with_status.status == "Unpaid" and not item_with_status.item.is_not_responsible %}selected{% endif %}> 
                                                                Unpaid 
                                                            </option> 
                                                            <option value="Paid" {% if item_with_status.status == "Paid" and not item_with_status.item.is_not_responsible %}selected{% endif %}> 
                                                                Paid 
                                                            </option> 
                                                            <option value="NOT RESPONSIBLE" {% if item_with_status.item.is_not_responsible %}selected{% endif %}> 
                                                                Not Responsible 
                                                            </option> 
                                                        </select> 
                                                        <button type="submit" class="update-button"  data-item-id="{{ item_with_status.item.id }}">Update 
                                                        </button> 
                                                    </form> 
                                                </div> 
                                            {% else %} 
                                                - 
                                            {% endif %} 
                                        </td> 
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    {% else %} 
                        <div>No payment items found.</div> 
                    {% endfor %} 
                
            </div> 
        </div> 
    </div> 
    <script>
        function openTab(tabName) {
            const tabs = document.querySelectorAll('.tab-content');
            const buttons = document.querySelectorAll('.tab-button');
            for (let i = 0; i < tabs.length; i++) {
                tabs[i].classList.remove('active');
            }
            for (let i = 0; i < buttons.length; i++) {
                buttons[i].classList.remove('active');
            }
            document.getElementById(tabName).classList.add('active');
            event.currentTarget.classList.add('active');
        }

        // --- Custom Select Logic ---
        document.querySelectorAll('.custom-select-wrapper').forEach(wrapper => {
            const trigger = wrapper.querySelector('.custom-select-trigger');
            const options = wrapper.querySelector('.custom-options');
            const listItems = options.querySelectorAll('li');

            trigger.addEventListener('click', () => {
                const triggerId = trigger.id;
                wrapper.classList.toggle('open');
                options.style.display = wrapper.classList.contains('open') ? "block" : "none";
                console.log(`Dropdown trigger clicked! ID: ${triggerId}`);
            });

            listItems.forEach(item => {
                item.addEventListener('click', () => {
                    const value = item.dataset.value;
                    trigger.querySelector('span').textContent = item.textContent;
                    wrapper.classList.remove('open');
                    options.style.display = "none";
                    if (wrapper.id === 'academic-year-filter-wrapper') {
                        selectedAcademicYear = value;
                    } else if (wrapper.id === 'semester-filter-wrapper') {
                        selectedSemester = value;
                    }
                    updateMembershipTable();
                });
            });
        });

        // Close select when clicking outside
        document.addEventListener('click', (event) => {
            if (!event.target.closest('.custom-select-wrapper')) {
                document.querySelectorAll('.custom-select-wrapper.open').forEach(openWrapper => {
                    openWrapper.classList.remove('open');
                    openWrapper.querySelector('.custom-options').style.display = 'none';
                });
            }
        });

        let selectedAcademicYear = "";
        let selectedSemester = "";

       async function updateMembershipTable() {
            const table = document.getElementById("membership-table").getElementsByTagName('tbody')[0];
            table.innerHTML = ""; // Clear the table

            console.log("Academic Year Filter:", selectedAcademicYear);
            console.log("Semester Filter:", selectedSemester);

            let url = "/admin/membership/";
            let queryParams = [];

            if (selectedAcademicYear) {
                queryParams.push(`academic_year=${selectedAcademicYear}`);
            }
            if (selectedSemester) {
                queryParams.push(`semester=${selectedSemester}`);
            }

            if (queryParams.length > 0) {
                url += "?" + queryParams.join("&");
            }

            let totalPaidSum = 0;
            let totalAmountSum = 0;
            let totalPaidMembers = 0;
            let totalMembersCount = 0;
            let overallStatus = "";

            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();

                data.forEach(item => {
                    let row = table.insertRow();
                    let yearCell = row.insertCell();
                    let sectionCell = row.insertCell();
                    let totalPaidCell = row.insertCell();
                    let totalAmountCell = row.insertCell();
                    let statusCell = row.insertCell();
                    let listCell = row.insertCell();

                    yearCell.textContent = item.year_level;
                    sectionCell.textContent = item.section;
                    totalPaidCell.textContent = item.total_paid;
                    totalAmountCell.textContent = item.total_amount;
                    statusCell.textContent = item.status;
                    listCell.innerHTML = `<a href="/admin/payments/total_members?year_level=${item.year_level}&section=${item.section}" class="view-history-link">View</a>`;

                    totalPaidSum += item.total_paid;
                    totalAmountSum += item.total_amount;

                    const [paidCountStr, totalCountStr] = item.status.split('/');
                    if (paidCountStr && totalCountStr) {
                        totalPaidMembers += parseInt(paidCountStr);
                        totalMembersCount += parseInt(totalCountStr);
                    } else if (item.status) {
                        totalMembersCount += parseInt(item.status);
                    }
                });

                if (selectedAcademicYear && selectedSemester) {
                    overallStatus = `${totalPaidMembers}/${totalMembersCount}`;
                } else {
                    overallStatus = `${totalMembersCount}`;
                }

                document.getElementById('total-paid-sum').textContent = totalPaidSum;
                document.getElementById('total-amount-sum').textContent = totalAmountSum;
                document.getElementById('total-status-summary').textContent = overallStatus;

            } catch (error) {
                console.error("Failed to fetch membership data:", error);
                table.innerHTML = `<tr><td colspan="9">Error loading data. Please check console.</td></tr>`;
            }
        }

document.addEventListener('DOMContentLoaded', function () {
    updateMembershipTable();
    document.querySelectorAll('.update-button').forEach(button => {
        button.addEventListener('click', function (event) {
            const itemId = this.dataset.itemId;
            updatePaymentStatus(event, itemId);
        });
    });
});

        async function updatePaymentStatus(event, itemId) {
            event.preventDefault();

            const statusSelect = document.getElementById(`status-select-${itemId}`);
            const selectedStatus = statusSelect.value;

            try {
                const response = await fetch(`/admin/payment/${itemId}/update_status`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `status=${encodeURIComponent(selectedStatus)}`,
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const statusCell = event.target.closest('tr').querySelector('td:nth-child(6)');
                statusCell.textContent = selectedStatus;
                statusCell.className = selectedStatus.toLowerCase();
            } catch (error) {
                console.error("Failed to update payment status:", error);
                alert('Failed to update status. Please check the console.');
            }
        }
    </script>
{% endblock %}
