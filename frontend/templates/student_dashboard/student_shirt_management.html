{% extends 'base.html' %}

{% block title %}Shirt Management{% endblock %}

{% block head %}
<link rel="stylesheet" href="/static/css/student_dashboard.css">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<style>
    /* Add or update your CSS for the remove button */
    .remove-order-button {
        background-color: #dc3545; /* Red color */
        color: white;
        padding: 10px 15px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 0.9em;
        margin-left: 10px; /* Space it from the payment button */
    }
    .remove-order-button:hover {
        background-color: #c82333;
    }

    /* Style for disabled payment buttons */
    .pay-button[disabled], .paid-button {
        background-color: #6c757d; /* Greyed out */
        cursor: not-allowed;
        opacity: 0.7;
    }
    .pay-button[disabled]:hover, .paid-button:hover {
        background-color: #6c757d; /* Keep same on hover for disabled */
    }

    /* --- NEW CSS for Edit Order Button --- */
    .edit-order-button {
        background-color: #007bff; /* Blue color */
        color: white;
        padding: 10px 15px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 0.9em;
        margin-left: 10px; /* Space it from other buttons */
    }
    .edit-order-button:hover {
        background-color: #0056b3;
    }
    /* Style for disabled edit buttons (if you implement that logic) */
    .edit-order-button[disabled] {
        background-color: #6c757d;
        cursor: not-allowed;
        opacity: 0.7;
    }
    /* --- END NEW CSS --- */

    /* Basic Modal Styling (if not already in student_dashboard.css) */
    .modal {
        display: none; /* Hidden by default */
        position: fixed; /* Stay in place */
        z-index: 1; /* Sit on top */
        left: 0;
        top: 0;
        width: 100%; /* Full width */
        height: 100%; /* Full height */
        overflow: auto; /* Enable scroll if needed */
        background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
        justify-content: center; /* Center horizontally */
        align-items: center; /* Center vertically */
        padding-top: 60px; /* Location of the box */
    }

    .modal-content {
        background-color: #fefefe;
        margin: auto; /* This centers it when display is block */
        padding: 20px;
        border: 1px solid #888;
        width: 80%; /* Could be more specific, e.g., 500px */
        max-width: 600px; /* Max width for larger screens */
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        position: relative; /* For the close button positioning */
    }

    .close-button {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        position: absolute;
        top: 10px;
        right: 20px;
    }

    .close-button:hover,
    .close-button:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
    }

    .form-group {
        margin-bottom: 15px;
    }

    .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
    }

    .form-group input[type="text"],
    .form-group input[type="email"],
    .form-group input[type="tel"],
    .form-group input[type="number"],
    .form-group select {
        width: calc(100% - 22px); /* Account for padding and border */
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-sizing: border-box; /* Include padding in width */
    }

    .total-amount-display {
        font-size: 1.1em;
        font-weight: bold;
        color: #28a745; /* Green for total */
        display: block; /* Ensures it takes full width */
        margin-top: 10px;
    }
    .submit-order-button, .button-primary {
        background-color: #007bff;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 1em;
        margin-top: 10px;
    }
    .submit-order-button:hover, .button-primary:hover {
        background-color: #0056b3;
    }
    .message-text, .message {
        margin-top: 10px;
        font-weight: bold;
    }
    .message-text.error, .message.error {
        color: red;
    }
    .message-text.success, .message.success {
        color: green;
    }
    .loading-message {
        text-align: center;
        color: #555;
    }
    .error-message {
        text-align: center;
        color: #dc3545;
    }
    .order-detail-actions {
        display: flex;
        justify-content: center;
        align-items: center;
        flex-wrap: wrap; /* Allow buttons to wrap on smaller screens */
        gap: 10px; /* Space between buttons */
        margin-top: 20px;
    }

    /* --- NEW CSS for hiding elements --- */
    .hidden-order {
        display: none !important; /* Important to override other display properties */
    }
    /* Styles for the new toggle button */
    .toggle-orders-button {
        background-color: #6c757d; /* Grey button */
        color: white;
        padding: 10px 15px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 0.9em;
        margin-top: 10px;
        margin-bottom: 20px; /* Space between button and order list */
        display: block; /* Make it a block element to take full width or allow margin auto */
        margin-left: auto; /* Center the button if container allows */
        margin-right: auto; /* Center the button if container allows */
    }
    .toggle-orders-button:hover {
        background-color: #5a6268;
    }
    .page-title {
        margin-bottom: 15px; /* Add some space below the title */
    }

</style>
{% endblock %}

{% block content %}

{# Shirt Campaigns Section #}
<div class="shirt-campaigns-page" id="campaigns-section">
    <h2 class="page-title">Available Shirt Campaigns</h2>
    <div class="campaigns-grid">
        {% if shirt_campaigns %}
            {% for campaign in shirt_campaigns %}
                <div class="campaign-card">
                    {% if campaign.size_chart_image_path %}
                    <div class="campaign-image-container">
                        <img src="{{ campaign.size_chart_image_path }}" alt="{{ campaign.title | e }} Size Chart" class="campaign-image">
                    </div>
                    {% else %}
                    <div class="campaign-image-container">
                        <img src="https://placehold.co/600x400/A0A0A0/FFFFFF?text=No+Size+Chart" alt="Placeholder Image" class="campaign-image">
                    </div>
                    {% endif %}
                    
                    <div class="campaign-card-content">
                        <h3 class="campaign-title">{{ campaign.title }}</h3>
                        <p class="campaign-description">{{ campaign.description }}</p>
                        <div class="campaign-details">
                            <p><strong>Price:</strong> &#8369;{{ "%.2f"|format(campaign.price_per_shirt) }}</p>
                            <p><strong>Available Stock:</strong> {{ campaign.available_stock }}</p>
                            <p><strong>Pre-order Deadline:</strong> {{ campaign.pre_order_deadline.strftime('%B %d, %Y') }}</p>
                        </div>
                        <div class="campaign-actions">
                            {% if campaign.pre_order_deadline and campaign.pre_order_deadline.date() < now().date() %}
                                <button class="closed-button" disabled>Pre-order Closed</button>
                            {% elif campaign.available_stock <= 0 %}
                                <button class="sold-out-button" disabled>Sold Out</button>
                            {% else %}
                                <button class="order-button"
                                        data-campaign-id="{{ campaign.id }}"
                                        data-campaign-title="{{ campaign.title | e }}"
                                        data-price-per-shirt="{{ campaign.price_per_shirt }}">
                                    Pre-order Now
                                </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <p class="no-campaigns-message">No active shirt campaigns at the moment.</p>
        {% endif %}
    </div>
</div>

---

<div id="orderModal" class="modal">
    <div class="modal-content">
        <span class="close-button">&times;</span>
        <h2>Place Your Order</h2>
        <h3 id="modalCampaignTitle"></h3>
        <form id="orderForm">
            <input type="hidden" id="modalCampaignId" name="campaign_id">
            <input type="hidden" id="modalOrderTotalAmount" name="order_total_amount">

            <div class="form-group">
                <label for="student_name">Your Name:</label>
                <input type="text" id="student_name" name="student_name" value="{{ current_user.first_name }} {{ current_user.last_name }}" required readonly>
            </div>
            <div class="form-group">
                <label for="student_year_section">Year & Section:</label>
                <input type="text" id="student_year_section" name="student_year_section" value="{{ current_user.year_level }} - {{ current_user.section }}" required>
            </div>
            <div class="form-group">
                <label for="student_email">Email (Optional):</label>
                <input type="email" id="student_email" name="student_email" value="{{ current_user.email or '' }}">
            </div>
            <div class="form-group">
                <label for="student_phone">Phone (Optional):</label>
                <input type="tel" id="student_phone" name="student_phone" value="{{ current_user.contact or '' }}">
            </div>
            <div class="form-group">
                <label for="shirt_size">Shirt Size:</label>
                <select id="shirt_size" name="shirt_size" required>
                    <option value="">Select Size</option>
                    <option value="XS">XS</option>
                    <option value="S">S</option>
                    <option value="M">M</option>
                    <option value="L">L</option>
                    <option value="XL">XL</option>
                    <option value="XXL">XXL</option>
                </select>
            </div>
            <div class="form-group">
                <label for="quantity">Quantity:</label>
                <input type="number" id="quantity" name="quantity" min="1" value="1" required>
            </div>
            <div class="form-group total-amount-display">
                <strong>Total Amount:</strong> <span id="displayTotalAmount">&#8369;0.00</span>
            </div>

            <button type="submit" class="submit-order-button">Submit Order</button>
            <p id="orderMessage" class="message-text"></p>
        </form>
    </div>
</div>

---

<div class="my-shirt-orders-page" id="my-orders-section">
    <h2 class="page-title">My Shirt Orders</h2>
    <button id="toggleCompletedOrdersButton" class="toggle-orders-button">Hide Completed Orders</button>

    <div class="orders-list-container">
        {% if student_shirt_orders %}
            {% for order in student_shirt_orders %}
                <div class="order-card order-item"
                     data-order-id="{{ order.id }}"
                     data-payment-status="{{ order.payment.status if order.payment else 'pending' }}">
                    <div class="order-header">
                        <h3 class="order-campaign-title">{{ order.campaign.title if order.campaign else 'N/A' }}</h3>
                      
                        <span class="order-status-tag tag-{{ (order.payment.status if order.payment else 'pending') | lower }}">
                            {{ order.payment.status if order.payment else 'Pending Payment' }}
                        </span>
                    </div>
                    <div class="order-details">
                        <p><strong>Order ID:</strong> {{ order.id }}</p>
                        <p><strong>Your Name:</strong> {{ order.student_name }}</p>
                        <p><strong>Year & Section:</strong> {{ order.student_year_section }}</p>
                        <p><strong>Size:</strong> {{ order.shirt_size }}</p>
                        <p><strong>Quantity:</strong> {{ order.quantity }}</p>
                        <p><strong>Total Amount:</strong> &#8369;{{ "%.2f"|format(order.order_total_amount) }}</p>
                        <p><strong>Ordered On:</strong> {{ order.ordered_at.strftime('%B %d, %Y %I:%M %p') }}</p>
                    </div>
                    <div class="order-actions">
                        {# Determine if payment is successful for button display #}
                        {% set is_payment_successful = order.payment and (order.payment.status == 'paid' or order.payment.status == 'success') %}

                        {% if not is_payment_successful %}
                            {# If payment is not successful, show the 'Complete Payment' button #}
                            <button class="pay-button paymaya-pay-button"
                                    data-payment-item-id="{{ order.payment.payment_item.id if order.payment and order.payment.payment_item else '' }}"
                                    data-order-id="{{ order.id }}">
                                Complete Payment
                            </button>
                        {% else %}
                            {# If payment is successful, show a disabled 'Payment Successful' button #}
                            <button class="paid-button" disabled style="cursor: not-allowed;">
                                Payment Successful
                            </button>
                        {% endif %}
                        
                        {# View Details Button (always available) #}
                        <button class="view-details-button" data-order-id="{{ order.id }}">View Details</button>
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <p class="no-orders-message">You have not placed any shirt orders yet.</p>
            <p class="cta-message">Check out the <a href="#campaigns-section">available campaigns</a> to place your first order!</p>
        {% endif %}
    </div>
</div>

---

{# Student Shirt Order Detail MODAL #}
<div id="orderDetailModal" class="modal">
    <div class="modal-content">
        <span class="close-button" id="closeOrderDetailModal">&times;</span>
        <h2 class="page-title">Order Details <span id="modalOrderDetailId"></span></h2>
        <div class="order-detail-card" id="orderDetailContent">
            {# Content will be dynamically loaded here by JavaScript #}
            <p class="loading-message">Loading order details...</p>
        </div>
        {# The payment and remove buttons will be injected by JavaScript into orderDetailContent #}
    </div>
</div>

---

{# NEW: Update Order Modal #}
<div id="updateOrderModal" class="modal">
    <div class="modal-content">
        <span class="close-button">&times;</span>
        <h2>Update Your Order</h2>
        <form id="updateOrderForm">
            <input type="hidden" id="updateOrderId" name="order_id">
            
            <div class="form-group">
                <label for="updateQuantity">Quantity:</label>
                <input type="number" id="updateQuantity" name="quantity" min="1" required>
            </div>
            
            <div class="form-group">
                <label for="updateShirtSize">Shirt Size:</label>
                <select id="updateShirtSize" name="shirt_size" required>
                    <option value="">Select Size</option>
                    <option value="XS">XS</option>
                    <option value="S">S</option>
                    <option value="M">M</option>
                    <option value="L">L</option>
                    <option value="XL">XL</option>
                    <option value="XXL">XXL</option> {# Make sure this matches your backend enum/schema #}
                </select>
            </div>

            <div class="form-group">
                <label>Current Total:</label>
                <span id="updateDisplayTotalAmount" class="total-amount-display">â‚±0.00</span>
                <input type="hidden" id="updateOrderTotalAmount" name="order_total_amount">
            </div>

            <button type="submit" class="button-primary">Update Order</button>
            <p id="updateOrderMessage" class="message"></p>
        </form>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    // Ensure these URLs are correctly defined by your Flask/Jinja2 app
    const CREATE_ORDER_URL = "{{ url_for('create_student_shirt_order_api') }}";
    const PAYMAYA_CREATE_PAYMENT_URL = "{{ url_for('paymaya_create_payment') }}";
    const GET_ORDER_DETAILS_URL_BASE = "{{ url_for('get_student_shirt_order_api', order_id='_PLACEHOLDER_') }}".replace('_PLACEHOLDER_', '');
    
    // *** THE CRUCIAL CHANGE FOR DELETE URL ***
    // Hardcode the base URL for the delete endpoint to match your FastAPI route.
    // Your FastAPI route is `@router.delete("/orders/{order_id}")`
    const DELETE_ORDER_URL_BASE = "/orders/";
    // If your FastAPI app is served under a prefix (e.g., /api), it would be:
    // const DELETE_ORDER_URL_BASE = "/api/orders/";
    // Double-check your app's main.py where you include the router.

    // --- NEW: Define URL for updating an order ---
    const UPDATE_ORDER_URL_BASE = "/orders/"; // Assumes PUT /orders/{order_id}
</script>
<script src="/static/js/student_dashboard/student_shirt_management.js"></script>
{% endblock %}